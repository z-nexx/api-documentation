## Purchase API

### Service Description
The purchase API provides information about purchases made through iZettle.

### URL
https://purchase.izettle.com

### Scopes
The Purchase API implements the following scopes:

- `READ:PURCHASE`

=== Get purchase history
Will include cash register information if applicable. Purchases up to three years old are available to fetch.

`GET /purchases/v2`

lastPurchaseHash (optional):: A value from "lastPurchaseHash" from the result of a previous history query, to continue listing purchases from the next record after the previous query.
startDate (optional):: The start date (inclusive) for purchases to be retrieved from until today or endDate. By default startDate is resolved to three years back.
endDate (optional):: The last date (exclusive) for purchases to be retrieved until.
limit (optional):: The maximum number of records to return. Max value of limit is 1000.
descending (optional):: When true, returns purchases with the highest timestamp first.  When false, returns purchases with the lowest timestamp first. Defaults to false if not specified.

Fields named "*UUID1" are the standard UUID Type 1 (8-4-4-4-12) representation of the UUID fields.  The "UUID" fields are Base64 encoded UUID.

#### Permissions required
`READ:PURCHASE`

#### Example response 1
`GET /purchases/v2?limit=10`
```json
{
  "purchases": [
    {
      "purchaseUUID": "6HbDrnUNRji5iniGikNLiQ",
      "purchaseUUID1": "fe8d0460-21c4-11e6-8ca8-3a4023ced819",
      "amount": 1500,
      "vatAmount": 161,
      "country": "SE",
      "currency": "SEK",
      "timestamp": "2015-02-08T10:21:21.469+0000",
      "gpsCoordinates": {
        "longitude": 18.44447366482676,
        "latitude": 60.416075632611964,
        "accuracyMeters": 65
      },
      "purchaseNumber": 1,
      "userDisplayName": "Ford Prefect",
      "userId": 1713921,
      "organizationId": 14184411,
      "products": [
        {
          "quantity": "1",
          "vatPercentage": 12,
          "unitPrice": 1500,
          "rowTaxableAmount": 1339,
          "name": "Enkel espresso",
          "productUuid": "32986b58-0753-11e8-bd3c-f5639f19b561",
          "variantUuid": "32986db0-0753-11e8-bd3c-f5639f19b561",
          "type": "PRODUCT",
          "id": "32986db0-0753-11e8-bd3c-f5639f19b567_28000001",
          "comment": "Med soya mjölk",
          "autoGenerated": false,
          "libraryProduct": true,
          "category": {
            "uuid": "5ed40c70-567c-11ea-ba9c-3338e0467dba",
            "name": "Coffee"
          }
        }
      ],
      "payments": [
        {
          "uuid": "683bdf49-7583-45bf-8d99-b6f031e82a74",
          "amount": 1500,
          "gratuityAmount": 0,
          "type": "IZETTLE_CARD",
          "attributes": {
            "transactionStatusInformation": "EC00",
            "cardPaymentEntryMode": "EMV",
            "maskedPan": "476173******0119",
            "installmentAmount": null,
            "referenceNumber": "AU54FYHW7X",
            "nrOfInstallments": 0,
            "cardType": "VISA",
            "terminalVerificationResults": "0080088000",
            "applicationIdentifier": "A0000000031010",
            "applicationName": "Visa Credit"
          }
        }
      ],
      "cashRegister": {
        "uuid": "r_dBcr6tT2ypC1jlMuUUzg",
        "displayName": "Kassa 1"
      },
      "receiptCopyAllowed": true,
      "groupedVatAmounts": {
        "12.0": 1500
      },
      "refund": false,
      "refunded": false
    },
    {
      "purchaseUUID": "zj9yI1wyTvqP46AG8NEaYg",
      "purchaseUUID1": "ce3f7223-5c32-4efa-8fe3-a006f0d11a62",
      "amount": 1500,
      "vatAmount": 161,
      "country": "SE",
      "currency": "SEK",
      "timestamp": "2015-02-08T10:22:08.355+0000",
      "gpsCoordinates": {
        "longitude": 17.53335989364865,
        "latitude": 58.772674182845805,
        "accuracyMeters": 65
      },
      "purchaseNumber": 2,
      "userDisplayName": "Ford Prefect",
      "userId": 1713921,
      "organizationId": 14184411,
      "products": [
        {
          "quantity": "1",
          "vatPercentage": 12,
          "unitPrice": 1500,
          "rowTaxableAmount": 1339,
          "name": "Enkel espresso",
          "productUuid": "32986b58-0753-11e8-bd3c-f5639f19b562",
          "variantUuid": "32986db0-0753-11e8-bd3c-f5639f19b562",
          "type": "PRODUCT",
          "id": "0",
          "autoGenerated": false,
          "libraryProduct": true,
          "category": {
            "uuid": "5ed40c70-567c-11ea-ba9c-3338e0467dba",
            "name": "Coffee"
          }
        }
      ],
      "payments": [
        {
          "uuid": "f091c978-bdb0-11e9-9cb5-2a2ae2dbcce4",
          "amount": 1500,
          "type": "IZETTLE_CASH",
          "attributes": {
            "handedAmount": 10000
          }
        }
      ],
      "cashRegister": {
        "uuid": "r_dBcr6tT2ypC1jlMuUUzg",
        "displayName": "Kassa 1"
      },
      "receiptCopyAllowed": true,
      "groupedVatAmounts": {
        "12.0": 1500
      },
      "refund": false,
      "refunded": false
    }
  ],
  "firstPurchaseHash": "14233908814696HbDrnUNRji5iniGikNLiQ",
  "lastPurchaseHash": "1423390928355zj9yI1wyTvqP46AG8NEaYg",
  "linkUrls": [
        "<https://purchase.izettle.com/purchases/v2?limit=10&descending=true&lastPurchaseHash=1423390928355zj9yI1wyTvqP46AG8NEaYg>; rel=\"next\""
  ]
}
```

#### Example response 2 (partial refund)

```json
{
  "purchases": [
    {
      "purchaseUUID": "DpNWkI7EEeaR8yfR3nmUIA",
      "amount": 17000,
      "country": "SE",
      "currency": "SEK",
      "timestamp": "2016-10-10T08:32:23.487+0000",
      "gpsCoordinates": {
        "longitude": 18.06672200650736,
        "latitude": 59.3343190127951,
        "accuracyMeters": 65
      },
      "purchaseNumber": 9,
      "userDisplayName": "Ford Prefect",
      "userId": 1713921,
      "organizationId": 14184411,
      "products": [
        {
          "quantity": "1",
          "unitPrice": 7500,
          "rowTaxableAmount": 7500,
          "name": "Vetelevain",
          "variantName": "Vetelevain",
          "autoGenerated": false,
          "type": "CUSTOM_AMOUNT",
          "id": "Vetelevain_7500",
          "libraryProduct": false
        },
        {
          "quantity": "1",
          "unitPrice": 6000,
          "name": "Källarfranska",
          "variantName": "Källarfranska",
          "autoGenerated": false,
          "type": "CUSTOM_AMOUNT",
          "id": "Källarfranska_6000",
          "libraryProduct": false
        },
        {
          "quantity": "1",
          "unitPrice": 3500,
          "rowTaxableAmount": 3500,
          "name": "Baguette",
          "variantName": "Baguette",
          "autoGenerated": false,
          "type": "CUSTOM_AMOUNT",
          "id": "Baguette_3500",
          "libraryProduct": false
        }
      ],
      "payments": [
       {
         "uuid": "ce90dc90-dcaa-11e6-87a4-0cd119752226",
         "amount": 17000,
         "type": "IZETTLE_CASH",
         "attributes": {
           "handedAmount": 17000
         }
       }
      ],
      "refundedByPurchaseUUIDs": [
        "HKXEKo7EEeaq_0GG8pcFtg"
      ],
      "receiptCopyAllowed": true,
      "published": true,
      "purchaseUUID1": "0e935690-8ec4-11e6-91f3-27d1de799420",
      "refundedByPurchaseUUIDs1": [
        "1ca5c42a-8ec4-11e6-aaff-4186f29705b6"
      ],
      "groupedVatAmounts": {},
      "refund": false,
      "refunded": true
    },
    {
      "purchaseUUID": "HKXEKo7EEeaq_0GG8pcFtg",
      "amount": -3500,
      "country": "SE",
      "currency": "SEK",
      "timestamp": "2016-10-10T08:32:42.675+0000",
      "gpsCoordinates": {
        "longitude": 18.06689298534442,
        "latitude": 59.33430848180441,
        "accuracyMeters": 65
      },
      "purchaseNumber": 10,
      "userDisplayName": "Ford Prefect",
      "userId": 1713921,
      "organizationId": 14184411,
      "products": [
        {
          "quantity": "-1",
          "unitPrice": 3500,
          "rowTaxableAmount": -3500,
          "name": "Baguette",
          "variantName": "Baguette",
          "autoGenerated": false,
          "type": "CUSTOM_AMOUNT",
          "id": "Baguette_3500",
          "libraryProduct": false
        }
      ],
      "payments": [
        {
           "uuid": "1ca7c4f0-8ec4-11e6-93fb-440a20c6bcbf",
           "amount": -3500,
           "type": "IZETTLE_CASH",
           "attributes": {
             "handedAmount": -3500
           }
        }
      ],
      "refundsPurchaseUUID": "DpNWkI7EEeaR8yfR3nmUIA",
      "receiptCopyAllowed": true,
      "published": true,
      "purchaseUUID1": "1ca5c42a-8ec4-11e6-aaff-4186f29705b6",
      "refundsPurchaseUUID1": "0e935690-8ec4-11e6-91f3-27d1de799420",
      "groupedVatAmounts": {},
      "refund": true,
      "refunded": false
    }
  ],
  "firstPurchaseHash": "14297979780492DpNWkI7EEeaR8yfR3nmUIA",
  "lastPurchaseHash": "1476088362675HKXEKo7EEeaq_0GG8pcFtg",
  "linkUrls": [
        "<https://purchase.izettle.com/purchases/v2?limit=10&descending=true&lastPurchaseHash=1476088362675HKXEKo7EEeaq_0GG8pcFtg>; rel=\"next\""
  ]
}
```

#### Example response 3 (discounts)
```json
{
  "purchases": [
    {
      "purchaseUUID": "biqV4OiTEea6-larSAFA7w",
      "amount": 10000,
      "vatAmount": 1331,
      "country": "SE",
      "currency": "SEK",
      "timestamp": "2017-02-01T15:31:00.648+0000",
      "purchaseNumber": 1507,
      "userDisplayName": "Ford Prefect",
      "userId": 1713921,
      "organizationId": 14184411,
      "products": [
        {
          "quantity": "2",
          "productUuid": "39cde734-e893-11e6-b8f1-2d3db21fba6a",
          "variantUuid": "302b4d5c-e893-11e6-b8f1-2d3db21fba6a",
          "type": "PRODUCT",
          "id" : "0",
          "vatPercentage": 25,
          "unitPrice": 2000,
          "rowTaxableAmount": 2240,
          "name": "Foo",
          "variantName": "",
          "discount": {
            "quantity": 1,
            "amount": 500
          },
          "discountValue": 500,
          "autoGenerated": false,
          "libraryProduct": true
        },
        {
          "quantity": "10",
          "productUuid": "4385c5ee-e893-11e6-b8f1-2d3db21fba6a",
          "variantUuid": "3bdf6232-e893-11e6-b8f1-2d3db21fba6a",
          "type": "PRODUCT",
          "id" : "1",
          "vatPercentage": 12,
          "unitPrice": 1000,
          "rowTaxableAmount": 6429,
          "name": "Bar",
          "variantName": "",
          "discount": {
            "quantity": 1,
            "percentage": 10
          },
          "discountValue": 1000,
          "autoGenerated": false,
          "libraryProduct": true
        }
      ],
      "discounts": [
        {
          "name": "",
          "percentage": 20,
          "quantity": 1
        }
      ],
      "payments": [
        {
          "uuid": "6f4e2e50-e893-11e6-a784-a603fda22c92",
          "amount": 10000,
          "type": "IZETTLE_CASH",
          "attributes": {
            "handedAmount": 10000
          }
        }
      ],
      "receiptCopyAllowed": true,
      "published": true,
      "purchaseUUID1": "6e2a95e0-e893-11e6-bafa-56ab480140ef",
      "groupedVatAmounts": {
        "12.0": 7200,
        "25.0": 2800
      },
      "refund": false,
      "refunded": false
    }
  ],
  "firstPurchaseHash": "1485857753809PaSsMOeeEeawkeLVV_68nw",
  "lastPurchaseHash": "1485858080407AOjsYOefEeax5pDdmnaGXw",
  "linkUrls": [
        "<https://purchase.izettle.com/purchases/v2?limit=10&descending=true&lastPurchaseHash=1485858080407AOjsYOefEeax5pDdmnaGXw>; rel=\"next\""
  ]
}
```

### Get purchase details

`GET /purchase/v2/{purchaseUUID}`

#### Permissions required
`READ:PURCHASE`

purchaseUUID:: The UUID of the purchase

#### Errors
404:: Purchase not found

#### Example response
`GET /purchase/v2/e876c3ae-750d-4638-b98a-78868a434b89`
```json
{
  "purchaseUUID": "6HbDrnUNRji5iniGikNLiQ",
  "purchaseUUID1": "e876c3ae-750d-4638-b98a-78868a434b89",
  "amount": 1500,
  "vatAmount": 161,
  "country": "SE",
  "currency": "SEK",
  "timestamp": "2015-02-08T10:21:21.469+0000",
  "gpsCoordinates": {
    "longitude": -73.99845698202617,
    "latitude": 40.734215418008596,
    "accuracyMeters": 65
  },
  "purchaseNumber": 1,
  "userDisplayName": "Stig Haraldsson",
  "products": [
    {
      "quantity": "1",
      "vatPercentage": 12,
      "unitPrice": 1500,
      "rowTaxableAmount": 1339,
      "name": "Enkel espresso",
      "productUuid": "32986b58-0753-11e8-bd3c-f5639f19b561",
      "variantUuid": "32986db0-0753-11e8-bd3c-f5639f19b561",
      "type": "PRODUCT",
      "id": "32986db0-0753-11e8-bd3c-f5639f19b567_28000001",
      "autoGenerated": false,
      "libraryProduct": true
    }
  ],
  "payments": [
    {
      "uuid": "165b88a0-07a3-11e6-9dae-43c30f1bff5b",
      "amount": 1500,
      "gratuityAmount": 0,
      "type": "IZETTLE_CARD",
      "attributes": {
        "transactionStatusInformation": "EC00",
        "cardPaymentEntryMode": "EMV",
        "maskedPan": "476173******0119",
        "installmentAmount": null,
        "referenceNumber": "AU54FYHW7X",
        "nrOfInstallments": 0,
        "cardType": "VISA",
        "terminalVerificationResults": "0080088000",
        "applicationIdentifier": "A0000000031010",
        "applicationName": "Visa Credit"
      }
    }
  ],
  "cashRegister": {
    "uuid": "r_dBcr6tT2ypC1jlMuUUzg",
    "displayName": "Kassa 1"
  },
  "receiptCopyAllowed": true,
  "refund": false,
  "groupedVatAmounts": {
    "12.0": 1500
  },
  "refunded": false
}
```

### Products

A purchase has one or more item lines represented in the `products` list attribute. The `type` attribute indicates what
kind of item line the entity represent, with `PRODUCT`, `CUSTOM_AMOUNT` and `GIFTCARD` being the currently available types.

In parallell to the `type` attribute there is an optional `details` attribute that may contain information related to the specific type,
for example item lines of type `GIFTCARD` will have a `giftcardUuid` attribute pointing out what giftcard that was sold/returned as part of purchases

### Payments

A purchase has one or more payments represented in the `payments` list attribute.

=== Payment attributes
The `payment` data type only contain a few generic parameters such as `uuid`, `amount` and `type`.

The currently available payment types are:

- `IZETTLE_CARD`
- `IZETTLE_CARD_ONLINE`
- `IZETTLE_CASH`
- `IZETTLE_INVOICE`
- `SWISH`
- `VIPPS`
- `MOBILE_PAY`
- `PAYPAL`
- `STORE_CREDIT`
- `GIFTCARD`
- `KLARNA`

Payment types are added when product offerings at iZettle changes, so for forwards-compatibility it is important that clients are tolerant of receiving payments of types that are not defined upfront.

To be able to represent all types of payments it has an `attributes` map that contain all payment type specific data such as `maskedPan` or `cardType` for card payments or `handedAmount` for cash payments.
Other payments such as Swish, Vipps and MobilePay don't have attributes. They will only be represented by a `uuid`, an `amount` and a `type`.

._example of cash payment_
```json
{
  "uuid": "ce90dc90-dcaa-11e6-87a4-0cd119752226",
  "amount": 1000,
  "type": "IZETTLE_CASH",
  "attributes": {
    "handedAmount": 1000
  }
}
```

._example of card payment_
```json
"purchaseUUID1": "fe8d0460-21c4-11e6-8ca8-3a4023ced819",
"amount": 2000,
"gratuityAmount": 0,
...
{
  "uuid": "165b88a0-07a3-11e6-9dae-43c30f1bff5b",
  "amount": 2000,
  "gratuityAmount": 0,
  "type": "IZETTLE_CARD",
  "attributes": {
    "transactionStatusInformation": "EC00",
    "cardPaymentEntryMode": "EMV",
    "maskedPan": "476173******0119",
    "installmentAmount": null,
    "referenceNumber": "AU54FYHW7X",
    "nrOfInstallments": 0,
    "cardType": "VISA",
    "terminalVerificationResults": "0080088000",
    "applicationIdentifier": "A0000000031010",
    "applicationName": "Visa Credit"
  }
}
```

._example of invoice payment_
```json
{
  "uuid": "d65ebf50-979e-11e7-9f72-df4bb64e0df9",
  "amount": 2960,
  "type": "IZETTLE_INVOICE",
  "attributes": {
    "orderUUID": "d5b126c4-979e-11e7-9af0-a3d2806c42a1",
    "invoiceNr": "iz37",
    "dueDate": "2017-10-12"
  }
}
```

_Note_: `gratuityAmount` corresponds to the tipping amount in the purchase. This
feature is not available in all countries. When the `gratuityAmount` is set, the
card payment amount will include the gratuity amount.


### Discounts
Discounts can exist both on a specific row of items in the shopping cart, as well as on the entire shopping cart. Discounts on a row of items is applied on the whole amount of the row. A discount can be set either as a percentage or as a fixed value.

When applying the total discounts on the purchase price, the row discounts will first be applied, followed by the cart discount which is then applied on the sum of the already discounted row prices.

#### VAT calculation when discounts have been applied
VAT is calculated after all the discounts have been applied. Since each row can have a separate VAT percentage the cart discount is evenly distributed over all row of items before the VAT per row of products can be calculated.

If the cart discount is a fixed value then that value will be deducted from each row according the price of each row in relation to the total purchase price.

##### Examples
If the cart discount is 20%, then the price of each row of item will be deducted with 20% before calculating the VAT for each row.

If a purchase has a total price of 100 and contains two rows with the first row priced at 40 and the second at 60, then 40% of the fixed cart discount will be deducted from the first row and 60% from the other row before calculating the VAT.

#### Response structure
Row discounts are expressed using the following JSON structure in the `products` list, containing either `amount` for fixed discounts or `percentage` for percentage discounts. The `discountValue` field following the `discount` structure contains the total discount amount for the row:
```json
"discount": {
  "quantity": 1,
  "percentage": 10
},
"discountValue": 1000
```
*Note:* Currently, we only support one discount per row of items, so the `quantity` field will always be set to 1. This could potentially change in the future.

Cart discounts are expressed using the following JSON structure in the root structure of the purchase. They can also contain either an `amount` or a `percentage` value:
```json
"discounts": [
{
    "name": "",
    "amount": 2000,
    "quantity": 1
}
```
*Note:* Currently, we only support one discount per cart, so the `discounts` list will only contain one item with `quantity` set to 1. This could potentially change in the future.

See further below for a full response example containing discounts.

#### Example
Lets observe an example purchase, containing both discounts on rows as well as on the cart itself:
[options="header"]
|===
| Product | Unit price | Amount | Discount
| Foo | 20 | 2 | 5
| Bar | 10 | 10 | 10%
| Cart discount | | | 20%
|===
To calculate the total discount, we start by calculating the discount per row. The first row contains 2 item and has a fixed discount amount of 5.

The second row contains 10 items and a percentage discount of 10%:

*Row discounts* = 5 + 10 x 10 x 0.1 = 15.

Then we calculate the cart discount, based on the sum of the previously discounted rows:

*Sum of discounted rows* = 20 x 2 + 10 x 10 - 15 = 125.

*Cart discount* = 125 x 0.2 = 25

So the total discount on this purchase is: 15 + 25 = 40. And the total sum to pay is: 140 - 40 = 100.

A discount can never be greater than the actual amount of the row or cart price.

### How to load all purchases for a user

You should never retrieve all the purchases in one request, since that can potentially put too much load on the server causing the request to be rejected or time out.

Instead, you should request the purchases splitted up into "pages", using the `limit` and `lastPurchaseHash` parameters, with `limit` set to maximum 1000.

The `limit` parameter will set the page size, and the `lastPurchaseHash` parameter sets the starting point from where to retrieve purchases. Every response from the purchase service will contain a `lastPurchaseHash` field, which can be added to the new request to retrieve the next "page". A prepared URL is also provided in attribute `linkUrls`, if more purchases are to be fetched.

In order to load all purchases, begin with an initial request without the `lastPurchaseHash` parameter being set, this will retrieve the first _n_ purchases (where _n_ is the page size defined by the `limit` parameter):

```
GET /purchases/v2?limit=50
```

The result will contain the first _n_ number of purchases.
```json
{
  "purchases": [
    ....
  ],
  "firstPurchaseHash": "14233908814696HbDrnUNRji5iniGikNLiQ",
  "lastPurchaseHash": "1423390928355zj9yI1wyTvqP46AG8NEaYg",
  "linkUrls": [
        "<https://purchase.izettle.com/purchases/v2?limit=10&descending=true&lastPurchaseHash=1423390928355zj9yI1wyTvqP46AG8NEaYg>; rel=\"next\""
  ]
}
```

To retrieve the following pages, use the value of `linkUrls` in the previous response to load the next page:
```
GET https://purchase.izettle.com/purchases/v2?limit=10&descending=true&lastPurchaseHash=1423390928355zj9yI1wyTvqP46AG8NEaYg
```

The result will contain the next _n_ number of purchases:
```json
{
  "purchases": [
    ....
  ],
  "firstPurchaseHash": "1423390928355zj9yI1wyTvqP46AG8NEaYg",
  "lastPurchaseHash": "1426265546490RPXdoMmDEeSg5Gw_2s_ZrQ",
  "linkUrls": [
        "<https://purchase.izettle.com/purchases/v2?limit=10&descending=true&lastPurchaseHash=1426265546490RPXdoMmDEeSg5Gw_2s_ZrQ; rel=\"next\""
  ]
}
```

Continue this process by using the `linkUrls` in the previous response as a request parameter in the following request until you receive an empty result.

If you want to be able to load new purchases later on, then store the last used `linkUrls` and use that to continue retrieving new purchases at a later time.
